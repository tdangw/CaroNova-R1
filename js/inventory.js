// üìÅ inventory.js - Qu·∫£n l√Ω b·ªô s∆∞u t·∫≠p ng∆∞·ªùi ch∆°i v√† AI (m·ªü r·ªông nhi·ªÅu lo·∫°i item)
import { SKINS } from './skins.js';
import { EFFECTS } from './effect.js';

const LOCKER_KEY = 'locker';
// L∆∞u √Ω: LOCKER_KEY l√† kh√≥a ƒë·ªÉ l∆∞u tr·ªØ b·ªô s∆∞u t·∫≠p qu√† t·∫∑ng trong localStorage
function getLocker() {
  return JSON.parse(localStorage.getItem(LOCKER_KEY) || '["gift-10coin"]');
}
function saveLocker(locker) {
  localStorage.setItem(LOCKER_KEY, JSON.stringify(locker));
}

const INVENTORY_KEY = 'inventory';
const ACTIVE_SKIN_KEY = 'activeSkin';
const AI_SKIN_KEY = 'aiSkin';
const COIN_KEY = 'coin';

const ALL_ITEMS = [...SKINS, ...EFFECTS];
const AI_SELECTED_ITEMS = {};

const CATEGORIES = {
  skin: 'Skin X/O',
  avatar: 'Avatar',
  border: 'Border',
  winfx: 'Effect',
  emote: 'Emote',
  locker: 'Locker', // üÜïT√≠nh nƒÉng m·ªõi b·ªï sung
};

let currentEffectSubTab = 'move-effect'; // move-effect | win-effect

export function getInventory() {
  return JSON.parse(localStorage.getItem(INVENTORY_KEY) || '[]');
}
export function saveInventory(inventory) {
  localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
}
export function ownsItem(id) {
  return getInventory().includes(id);
}

export function getActiveSkin() {
  return localStorage.getItem(ACTIVE_SKIN_KEY) || 'default';
}
export function setActiveSkin(id) {
  localStorage.setItem(ACTIVE_SKIN_KEY, id);
  if (typeof window.updateBoardIcons === 'function') window.updateBoardIcons();
}

export function getAISkin() {
  return localStorage.getItem(AI_SKIN_KEY) || 'ai-default';
}
export function setAISkin(id) {
  localStorage.setItem(AI_SKIN_KEY, id);
  if (typeof window.updateBoardIcons === 'function') window.updateBoardIcons();
}

export function getCoin() {
  return parseInt(localStorage.getItem(COIN_KEY) || '10000');
}
export function addCoin(amount) {
  localStorage.setItem(COIN_KEY, getCoin() + amount);
}
export function spendCoin(amount) {
  const current = getCoin();
  if (current >= amount) {
    localStorage.setItem(COIN_KEY, current - amount);
    return true;
  }
  return false;
}

export function getSelectedItem(type) {
  const selected = JSON.parse(localStorage.getItem('selectedItems') || '{}');
  return selected[type] || 'default';
}

export function setSelectedItem(type, id) {
  const selected = JSON.parse(localStorage.getItem('selectedItems') || '{}');
  selected[type] = id;
  localStorage.setItem('selectedItems', JSON.stringify(selected));
}

export function setAISelectedItem(type, id) {
  AI_SELECTED_ITEMS[type] = id;
}
export function getAISelectedItem(type) {
  if (type === 'skin') return getAISkin();
  return AI_SELECTED_ITEMS[type] || getDefaultAIItem(type);
}

function getDefaultAIItem(type) {
  const list = ALL_ITEMS.filter((i) =>
    type === 'winfx'
      ? i.type === 'win-effect' || i.type === 'move-effect'
      : i.type === type
  );
  return list.length > 0 ? list[0].id : null;
}

// üîß Qu·∫£n l√Ω s·ªë l∆∞·ª£ng √¥ locker ƒë√£ m·ªü (m·∫∑c ƒë·ªãnh l√† 4)
function getUnlockedCount() {
  return parseInt(localStorage.getItem('lockerUnlockedCount') || '4');
}

function increaseUnlockedCount() {
  const count = getUnlockedCount();
  localStorage.setItem('lockerUnlockedCount', count + 1);
}

export function openInventory(currentTab = 'skin') {
  const popup = document.getElementById('inventory-popup');
  popup.innerHTML = `
    <button class="inventory-close-btn" onclick="document.getElementById('inventory-popup').style.display='none'">‚úñ</button>
    <div class="overlay-box inventory-box">
      <h3>üéí B·ªô s∆∞u t·∫≠p c·ªßa B·∫°n</h3>
      
      <div style="margin: 6px 0; font-size: 1.1rem; color: gold;">
      <span style="font-size:1.2rem">üí∞</span> ${getCoin()} Xu
      </div>

      <div class="inventory-tabs">
        ${Object.entries(CATEGORIES)
          .map(
            ([key, label]) =>
              `<button class="inv-tab-btn ${
                key === currentTab ? 'active' : ''
              }" data-tab="${key}">${label}</button>`
          )
          .join('')}
      </div>
      ${
        currentTab === 'winfx'
          ? `<div class="inventory-subtabs" style="margin:8px 0;">
              <button class="inv-subtab-btn" data-subtab="move-effect" ${
                currentEffectSubTab === 'move-effect'
                  ? 'style="background:#0f0;color:black;"'
                  : ''
              }>Move Effect</button>
              <button class="inv-subtab-btn" data-subtab="win-effect" ${
                currentEffectSubTab === 'win-effect'
                  ? 'style="background:#0f0;color:black;"'
                  : ''
              }>Win Effect</button>
            </div>`
          : ''
      }
      <div id="inventory-list" class="inventory-list"></div>
      <div style="text-align:center;margin-top:12px;">
        <button onclick="document.getElementById('inventory-popup').style.display='none'">ƒê√≥ng</button>
      </div>
    </div>
  `;
  renderInventoryItems(currentTab, false);

  document.querySelectorAll('.inv-tab-btn').forEach((btn) => {
    btn.addEventListener('click', () => openInventory(btn.dataset.tab));
  });

  document.querySelectorAll('.inv-subtab-btn')?.forEach((btn) => {
    btn.addEventListener('click', () => {
      currentEffectSubTab = btn.dataset.subtab;
      openInventory('winfx');
    });
  });

  popup.style.display = 'block';
}

export function openAIInventory(currentTab = 'skin') {
  const popup = document.getElementById('inventory-popup');
  popup.innerHTML = `
    <button class="inventory-close-btn" onclick="document.getElementById('inventory-popup').style.display='none'">‚úñ</button>
    <div class="overlay-box inventory-box">
      <h3>ü§ñ B·ªô s∆∞u t·∫≠p c·ªßa <span style="color:#ffcc00;">AI</span></h3>
      <div class="inventory-tabs">
        ${Object.entries(CATEGORIES)
          .map(
            ([key, label]) =>
              `<button class="inv-tab-btn ${
                key === currentTab ? 'active' : ''
              }" data-tab="${key}">${label}</button>`
          )
          .join('')}
      </div>
      ${
        currentTab === 'winfx'
          ? `<div class="inventory-subtabs" style="margin:8px 0;">
              <button class="inv-subtab-btn" data-subtab="move-effect" ${
                currentEffectSubTab === 'move-effect'
                  ? 'style="background:#0f0;color:black;"'
                  : ''
              }>Move Effect</button>
              <button class="inv-subtab-btn" data-subtab="win-effect" ${
                currentEffectSubTab === 'win-effect'
                  ? 'style="background:#0f0;color:black;"'
                  : ''
              }>Win Effect</button>
            </div>`
          : ''
      }
      <div id="inventory-list" class="inventory-list"></div>
      <div style="text-align:center;margin-top:12px;">
        <button onclick="document.getElementById('inventory-popup').style.display='none'">ƒê√≥ng</button>
      </div>
    </div>
  `;
  renderInventoryItems(currentTab, true);

  document.querySelectorAll('.inv-tab-btn').forEach((btn) => {
    btn.addEventListener('click', () => openAIInventory(btn.dataset.tab));
  });

  document.querySelectorAll('.inv-subtab-btn')?.forEach((btn) => {
    btn.addEventListener('click', () => {
      currentEffectSubTab = btn.dataset.subtab;
      openAIInventory('winfx');
    });
  });

  popup.style.display = 'block';
}

function renderInventoryItems(tabKey, isAI = false) {
  const list = document.getElementById('inventory-list');
  list.innerHTML = '';
  if (tabKey === 'locker') {
    const locker = getLocker();
    const unlockedCount = getUnlockedCount();

    for (let i = 0; i < 24; i++) {
      const itemId = locker[i] || null;
      const div = document.createElement('div');
      div.className = 'inventory-item';

      if (i < unlockedCount) {
        // ‚úÖ ƒê√£ m·ªü
        div.style.opacity = itemId ? 1 : 0.3;
        div.innerHTML = `
        <div class="effect-preview-box">${itemId ? 'üéÅ' : 'üîì'}</div>
        <div class="skin-name">${itemId || 'Tr·ªëng'}</div>
      `;
        if (itemId && itemId.startsWith('gift-')) {
          div.style.cursor = 'pointer';
          div.addEventListener('click', () => showGiftPopup(i, itemId));
        }
      } else if (i === unlockedCount) {
        // ‚úÖ ƒê∆∞·ª£c ph√©p m·ªü √¥ k·∫ø ti·∫øp
        const price = 100 + (i - 4) * 20;
        div.style.opacity = 0.9;
        div.innerHTML = `
        <div class="effect-preview-box">üîí</div>
        <div class="skin-name">M·ªü: ${price} Xu</div>
      `;
        div.style.cursor = 'pointer';
        div.addEventListener('click', () => tryUnlockLocker(i, price));
      } else {
        // üîí C√°c √¥ c√≤n l·∫°i b·ªã kh√≥a
        div.style.opacity = 0.2;
        div.innerHTML = `
        <div class="effect-preview-box">üîí</div>
        <div class="skin-name">Ch∆∞a m·ªü</div>
      `;
      }

      list.appendChild(div);
    }

    return;
  }

  const inventory = isAI ? ALL_ITEMS.map((i) => i.id) : getInventory();

  const items = ALL_ITEMS.filter(
    (i) =>
      (tabKey === 'winfx'
        ? i.type === currentEffectSubTab
        : i.type === tabKey) && inventory.includes(i.id)
  );

  if (items.length === 0) {
    list.innerHTML =
      '<p class="empty-msg">(Ch∆∞a c√≥ v·∫≠t ph·∫©m n√†o thu·ªôc nh√≥m n√†y)</p>';
    return;
  }

  items.forEach((item) => {
    const current =
      item.type === 'skin'
        ? isAI
          ? getAISkin()
          : getActiveSkin()
        : isAI
        ? getAISelectedItem(item.type)
        : getSelectedItem(item.type);

    const div = document.createElement('div');
    div.className = 'inventory-item';

    div.innerHTML = `
      <div class="effect-preview-box">
        <span class="preview-icon">${item.icon}</span>
      </div>
      <div class="skin-name">${item.name}</div>
      ${getRarityLabel(item.rarity)}
      <button ${item.id === current ? 'disabled' : ''}>
        ${item.id === current ? 'ƒêang d√πng' : 'D√πng'}
      </button>
    `;

    // N·∫øu l√† hi·ªáu ·ª©ng (winfx), k√≠ch ho·∫°t hi·ªáu ·ª©ng ƒë·ªông khi hover
    const preview = div.querySelector('.preview-icon');
    if (preview && tabKey === 'winfx' && item.class) {
      div.addEventListener('mouseenter', () =>
        preview.classList.add(item.class)
      );
      div.addEventListener('mouseleave', () =>
        preview.classList.remove(item.class)
      );
    }

    div.querySelector('button').addEventListener('click', () => {
      if (item.type === 'skin') {
        isAI ? setAISkin(item.id) : setActiveSkin(item.id);
      } else {
        isAI
          ? setAISelectedItem(item.type, item.id)
          : setSelectedItem(item.type, item.id);
      }
      isAI ? openAIInventory(tabKey) : openInventory(tabKey);
    });

    list.appendChild(div);
  });
}

function getRarityLabel(rarity) {
  if (rarity === 'legendary')
    return '<div class="rarity-label legendary">Huy·ªÅn tho·∫°i</div>';
  if (rarity === 'rare') return '<div class="rarity-label rare">Hi·∫øm</div>';
  return '';
}

function tryUnlockLocker(index, price) {
  const unlockedCount = getUnlockedCount();
  if (index !== unlockedCount) {
    alert('‚ö†Ô∏è B·∫°n c·∫ßn m·ªü √¥ tr∆∞·ªõc ƒë·ªÉ m·ªü √¥ n√†y!');
    return;
  }

  if (getCoin() < price) {
    alert(`‚ö†Ô∏è B·∫°n c·∫ßn ${price} Xu ƒë·ªÉ m·ªü √¥ n√†y!`);
    return;
  }

  const confirmBox = document.createElement('div');
  confirmBox.className = 'gift-popup';
  confirmBox.innerHTML = `
    <div class="overlay-box">
      <h3>üîì M·ªü √¥ Locker?</h3>
      <p>B·∫°n s·∫Ω m·∫•t <b>${price} Xu</b> ƒë·ªÉ m·ªü √¥ n√†y.</p>
      <button id="confirm-unlock">M·ªü</button>
      <button id="cancel-unlock">H·ªßy</button>
    </div>
  `;
  document.body.appendChild(confirmBox);

  document.getElementById('confirm-unlock').onclick = () => {
    spendCoin(price);
    increaseUnlockedCount();
    confirmBox.remove();
    openInventory('locker');
  };

  document.getElementById('cancel-unlock').onclick = () => confirmBox.remove();
}

//
function showGiftPopup(index, giftId) {
  const popup = document.createElement('div');
  popup.className = 'gift-popup';

  let preview = 'üéÅ'; // bi·ªÉu t∆∞·ª£ng m·∫∑c ƒë·ªãnh
  let message = 'B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c ph·∫ßn th∆∞·ªüng ƒë·∫∑c bi·ªát!';

  // X√°c ƒë·ªãnh n·ªôi dung v√† bi·ªÉu t∆∞·ª£ng theo lo·∫°i qu√†
  if (giftId === 'gift-10coin') {
    preview = 'üí∞';
    message = 'B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c <b>10 Xu</b>.';
  } else if (giftId === 'gift-random-coin') {
    preview = 'üé≤üí∞';
    message = 'B·∫°n s·∫Ω nh·∫≠n <b>ng·∫´u nhi√™n t·ª´ 1‚Äì10 Xu</b>.';
  } else if (giftId.startsWith('gift-1skin-')) {
    const skinId = giftId.replace('gift-1skin-', '');
    preview = 'üé®';
    message = `B·∫°n s·∫Ω nh·∫≠n skin m·ªõi: <b>${skinId}</b>`;
  } else if (giftId === 'gift-random-skin') {
    preview = 'üé≤üé®';
    message = 'B·∫°n s·∫Ω nh·∫≠n <b>ng·∫´u nhi√™n 1 skin ch∆∞a s·ªü h·ªØu</b>.';
  } else if (giftId.startsWith('gift-1emote-')) {
    const emoteId = giftId.replace('gift-1emote-', '');
    preview = 'üí¨';
    message = `B·∫°n s·∫Ω nh·∫≠n emote m·ªõi: <b>${emoteId}</b>`;
  } else if (giftId === 'gift-random-emote') {
    preview = 'üé≤üí¨';
    message = 'B·∫°n s·∫Ω nh·∫≠n <b>ng·∫´u nhi√™n 1 emote ch∆∞a s·ªü h·ªØu</b>.';
  }

  popup.innerHTML = `
    <div class="overlay-box" style="text-align:center;">
      <h3>${preview} M·ªü h·ªôp qu√†?</h3>
      <p>${message}</p>
      <button id="open-gift">üéâ M·ªü</button>
      <button id="cancel-gift">‚ùå H·ªßy</button>
    </div>
  `;
  document.body.appendChild(popup);

  document.getElementById('open-gift').onclick = () => {
    const locker = getLocker();
    locker[index] = null;
    saveLocker(locker);

    const inv = getInventory();

    if (giftId === 'gift-10coin') {
      addCoin(10);
    } else if (giftId === 'gift-random-coin') {
      const amount = Math.floor(Math.random() * 10) + 1;
      addCoin(amount);
    } else if (giftId.startsWith('gift-1skin-')) {
      const skinId = giftId.replace('gift-1skin-', '');
      if (!inv.includes(skinId)) {
        inv.push(skinId);
        saveInventory(inv);
      }
    } else if (giftId === 'gift-random-skin') {
      const skins = SKINS.filter(
        (s) => s.type === 'skin' && !inv.includes(s.id)
      );
      if (skins.length > 0) {
        const random = skins[Math.floor(Math.random() * skins.length)];
        inv.push(random.id);
        saveInventory(inv);
      }
    } else if (giftId.startsWith('gift-1emote-')) {
      const emoteId = giftId.replace('gift-1emote-', '');
      if (!inv.includes(emoteId)) {
        inv.push(emoteId);
        saveInventory(inv);
      }
    } else if (giftId === 'gift-random-emote') {
      const emotes = EFFECTS.filter(
        (e) => e.type === 'emote' && !inv.includes(e.id)
      );
      if (emotes.length > 0) {
        const random = emotes[Math.floor(Math.random() * emotes.length)];
        inv.push(random.id);
        saveInventory(inv);
      }
    }

    popup.remove();
    openInventory('locker');
  };

  document.getElementById('cancel-gift').onclick = () => popup.remove();
}
